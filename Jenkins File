pipeline {
    agent any
    environment {
        DOCKER_IMAGE = 'akshat122001/webapp'
        BUILD_ID = "${env.BUILD_NUMBER}"
    }
    stages {
        stage('Check for Dockerfile') {
            steps {
                script {
                    if (!fileExists('Dockerfile')) {
                        error("Dockerfile not found in repository root!")
                    }
                }
            }
        }
        stage('Build') {
            environment {
                DOCKER_BUILDKIT = "1"  # Enable BuildKit
            }
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${BUILD_ID}")
                }
            }
        }
        stage('Test') {
            steps {
                script {
                    docker.image("${DOCKER_IMAGE}:${BUILD_ID}").inside {
                        sh 'curl -I http://localhost || exit 1'
                    }
                }
            }
        }
        stage('Deploy') {
            when { branch 'master' }
            steps {
                echo "Deployment would happen here"
                // Add your deployment steps
            }
        }
    }
    post {
        failure {
            slackSend channel: '#devops',
                     message: "❌ FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }
        success {
            slackSend channel: '#devops',
                     message: "✅ SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }
    }
}
